## **修改后的游客小程序API**

### **认证模块（新增）**

| 功能模块       | API名称        | 方法 | 请求参数                         | 返回数据                            | 说明                        |
| :------------- | :------------- | :--- | :------------------------------- | :---------------------------------- | :-------------------------- |
| **用户注册**   | `userRegister` | POST | `{username, password, nickName}` | `{userId, token}`                   | 创建账号，密码需前端MD5加密 |
| **用户登录**   | `userLogin`    | POST | `{username, password}`           | `{userId, token, nickName, avatar}` | 返回JWT Token               |
| **手机号绑定** | `bindPhone`    | POST | `{phone, code}`                  | 成功提示                            | 可选，用于找回密码          |

### **调整后的原有API**

| 功能模块       | API名称           | 方法 | 请求参数                                                     | 返回数据                                                     | 说明                                |
| :------------- | :---------------- | :--- | :----------------------------------------------------------- | :----------------------------------------------------------- | :---------------------------------- |
| **引领区简介** | `getIntroduction` | GET  | 无                                                           | 不变                                                         | 无需登录                            |
| **景点列表**   | `getSpotList`     | GET  | `{lat, lng}`                                                 | 不变                                                         | 无需登录                            |
| **拍照打卡**   | `createCheckIn`   | POST | `{spotId, photoFileID, comment}` **+ Header: `Authorization: Bearer <token>`** | 成功提示                                                     | **需登录**，后台校验token获取userId |
| **打卡排名**   | `getRanking`      | GET  | `{page}`                                                     | 不变                                                         | 无需登录                            |
| **附近推荐**   | `getNearbySpots`  | GET  | `{lat, lng, limit}`                                          | 不变                                                         | 无需登录                            |
| **点评广场**   | `getFeedList`     | GET  | `{page}`                                                     | 不变                                                         | 无需登录                            |
| **点赞**       | `likeCheckIn`     | POST | `{checkInId}` **+ Header: `Authorization: Bearer <token>`**  | `{likeCount}`                                                | **需登录**，防止重复点赞            |
| **个人中心**   | `getUserProfile`  | GET  | **Header: `Authorization: Bearer <token>`**                  | `{userId, nickName, avatar, phone, totalPoints, checkInCount}` | **需登录**，返回个人信息            |
| **更新头像**   | `updateAvatar`    | POST | `{avatarUrl}` **+ Header: `Authorization: Bearer <token>`**  | 成功提示                                                     | `avatarUrl`为云存储文件ID           |
| **我的打卡**   | `getMyCheckIns`   | GET  | `{page}` **+ Header: `Authorization: Bearer <token>`**       | 不变                                                         | **需登录**，返回个人记录            |
| **积分商城**   | `getPrizeList`    | GET  | 无                                                           | 不变                                                         | 无需登录                            |
| **兑换奖品**   | `exchangePrize`   | POST | `{prizeId}` **+ Header: `Authorization: Bearer <token>`**    | `{exchangeCode}`                                             | **需登录**，扣除积分                |
| **积分明细**   | `getPointLog`     | GET  | `{page}` **+ Header: `Authorization: Bearer <token>`**       | 不变                                                         | **需登录**，返回个人积分流水        |

------

## **修改后的管理端API**

表格

复制

| 功能模块       | API名称        | 方法   | 请求参数                             | 返回数据                                                     | 说明                    |
| :------------- | :------------- | :----- | :----------------------------------- | :----------------------------------------------------------- | :---------------------- |
| **管理员登录** | `adminLogin`   | POST   | `{username, password}`               | `{token}`                                                    | 简易账号密码，返回token |
| **景点管理**   | `createSpot`   | POST   | 不变                                 | 不变                                                         | 需管理员token           |
|                | `updateSpot`   | PUT    | 不变                                 | 不变                                                         | 需管理员token           |
|                | `deleteSpot`   | DELETE | 不变                                 | 不变                                                         | 需管理员token           |
|                | `getAllSpots`  | GET    | 不变                                 | 完整景点列表                                                 | 需管理员token           |
| **兑奖核销**   | `verifyPrize`  | POST   | 不变                                 | **返回字段改为**：`{userId, userNickName, prizeInfo}`        | 核销兑换码              |
| **用户管理**   | `getUserList`  | GET    | `{page, keyword}`                    | **返回字段改为**：`[{userId, username, nickName, phone, points, checkInCount}]` | 按用户名/昵称搜索       |
| **调整积分**   | `adjustPoints` | POST   | **改为**：`{userId, points, reason}` | 成功提示                                                     | 手动增减积分            |

------

## **修改后的核心表结构**

### **1. 用户主表 (users) ** - ** 合并微信信息，增加登录字段 **

sql

复制

```sql
CREATE TABLE `users` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '用户ID',
  `username` VARCHAR(50) NOT NULL COMMENT '登录账号',
  `password_hash` VARCHAR(255) NOT NULL COMMENT '密码哈希(Bcrypt)',
  `nick_name` VARCHAR(100) DEFAULT '' COMMENT '用户昵称',
  `avatar_url` VARCHAR(500) DEFAULT '' COMMENT '头像URL',
  `phone` VARCHAR(20) DEFAULT '' COMMENT '手机号',
  `total_points` INT NOT NULL DEFAULT 0 COMMENT '总积分',
  `check_in_count` INT NOT NULL DEFAULT 0 COMMENT '累计打卡数',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  `deleted_at` TIMESTAMP NULL DEFAULT NULL COMMENT '软删除时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`),
  UNIQUE KEY `uk_phone` (`phone`),
  KEY `idx_points` (`total_points`),
  KEY `idx_checkin` (`check_in_count`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户主表';
```

### ** 2. 景点表 (spots) ** - ** 不变 **

sql

复制

```sql
CREATE TABLE `spots` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '景点ID',
  `name` VARCHAR(100) NOT NULL COMMENT '景点名称',
  `lat` DECIMAL(10, 8) NOT NULL COMMENT '纬度',
  `lng` DECIMAL(11, 8) NOT NULL COMMENT '经度',
  `description` TEXT COMMENT '景点描述',
  `image` VARCHAR(500) DEFAULT '' COMMENT '景点图片',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态：1启用 0禁用',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`),
  SPATIAL KEY `idx_location` (`lat`, `lng`) -- 地理位置空间索引
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='景点表';
```

### ** 3. 打卡记录表 (check_ins) ** - ** user_id关联不变 **

sql

复制

```sql
CREATE TABLE `check_ins` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '打卡ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `spot_id` BIGINT UNSIGNED NOT NULL COMMENT '景点ID',
  `photo_file_id` VARCHAR(200) NOT NULL COMMENT '云存储文件ID',
  `comment` VARCHAR(500) DEFAULT '' COMMENT '评论',
  `points_earned` INT NOT NULL DEFAULT 0 COMMENT '获得积分',
  `check_lat` DECIMAL(10, 8) NOT NULL COMMENT '打卡时纬度',
  `check_lng` DECIMAL(11, 8) NOT NULL COMMENT '打卡时经度',
  `distance` DECIMAL(8, 2) DEFAULT NULL COMMENT '与景点直线距离(米)',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态：1有效 0无效',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_spot_id` (`spot_id`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_checkin_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_checkin_spot` FOREIGN KEY (`spot_id`) REFERENCES `spots` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='打卡记录表';
```

### ** 4. 积分日志表 (point_logs) ** - ** 不变 **

sql

复制

```sql
CREATE TABLE `point_logs` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '日志ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `type` ENUM('check_in', 'like', 'exchange', 'admin_adjust', 'system') NOT NULL COMMENT '变动类型',
  `points` INT NOT NULL COMMENT '变动积分(正数增加/负数减少)',
  `balance` INT NOT NULL COMMENT '变动后余额',
  `source_id` BIGINT UNSIGNED DEFAULT NULL COMMENT '关联业务ID(如打卡ID)',
  `description` VARCHAR(200) DEFAULT '' COMMENT '描述',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_type` (`type`),
  KEY `idx_created_at` (`created_at`),
  CONSTRAINT `fk_pointlog_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='积分变动日志表';
```

### ** 5. 奖品表 (prizes) ** - ** 不变 **

sql

复制

```sql
CREATE TABLE `prizes` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '奖品ID',
  `name` VARCHAR(100) NOT NULL COMMENT '奖品名称',
  `points` INT NOT NULL COMMENT '所需积分',
  `stock` INT NOT NULL DEFAULT 0 COMMENT '库存',
  `description` TEXT COMMENT '奖品描述',
  `image` VARCHAR(500) DEFAULT '' COMMENT '奖品图片',
  `status` TINYINT NOT NULL DEFAULT 1 COMMENT '状态：1上架 0下架',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='奖品表';
```

### ** 6. 兑换记录表 (exchange_records) ** - ** 不变 **

sql

复制

```sql
CREATE TABLE `exchange_records` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT '兑换记录ID',
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `prize_id` BIGINT UNSIGNED NOT NULL COMMENT '奖品ID',
  `exchange_code` CHAR(8) NOT NULL COMMENT '8位兑换码',
  `status` ENUM('pending', 'used', 'expired') NOT NULL DEFAULT 'pending' COMMENT '状态',
  `used_at` TIMESTAMP NULL DEFAULT NULL COMMENT '核销时间',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_exchange_code` (`exchange_code`),
  KEY `idx_user_id` (`user_id`),
  KEY `idx_status` (`status`),
  CONSTRAINT `fk_exchange_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_exchange_prize` FOREIGN KEY (`prize_id`) REFERENCES `prizes` (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='奖品兑换记录表';
```

### ** 7. 点赞表 (likes) ** - ** 不变 **

sql

复制

```sql
CREATE TABLE `likes` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `user_id` BIGINT UNSIGNED NOT NULL COMMENT '用户ID',
  `check_in_id` BIGINT UNSIGNED NOT NULL COMMENT '打卡记录ID',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_user_checkin` (`user_id`, `check_in_id`) COMMENT '防止重复点赞',
  KEY `idx_check_in_id` (`check_in_id`),
  CONSTRAINT `fk_like_user` FOREIGN KEY (`user_id`) REFERENCES `users` (`id`) ON DELETE CASCADE,
  CONSTRAINT `fk_like_checkin` FOREIGN KEY (`check_in_id`) REFERENCES `check_ins` (`id`) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='点赞关系表';
```

### ** 8. 管理员表 (admins) ** - ** 不变 **

sql

复制

```sql
CREATE TABLE `admins` (
  `id` BIGINT UNSIGNED NOT NULL AUTO_INCREMENT,
  `username` VARCHAR(50) NOT NULL COMMENT '管理员账号',
  `password_hash` VARCHAR(255) NOT NULL COMMENT '密码哈希',
  `role` VARCHAR(20) DEFAULT 'admin' COMMENT '角色',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_username` (`username`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='管理员表';
```

